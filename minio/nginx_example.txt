upstream minio_cluster {
    # Deve falhar 2 vezes no intervalo de 5s antes de ir para o proximo upstream
	server	127.0.0.1:9000 max_fails=2 fail_timeout=5s; 
	server	127.0.0.1:9002 max_fails=2 fail_timeout=5s;
}

server{
	listen	80;
	server_name	cdn-local.metacloud.com.br;
	client_max_body_size	0;

	location / {
		proxy_pass	http://minio_cluster;
		
		# Headers essenciais para o MinIO funcionar corretamente atrás de um proxy
	        proxy_set_header Host            $http_host; # Necessário para MinIO identificar o bucket correto
		proxy_set_header X-Real-IP       $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme; # Informa se a conexão original era HTTP ou HTTPS
		
		# Otimizações para streaming de arquivos grandes (S3)
		proxy_connect_timeout      300s; # Tempo para conectar ao backend
		proxy_send_timeout         300s; # Tempo para enviar dados ao backend
		proxy_read_timeout         300s; # Tempo para ler dados do backend
		proxy_http_version         1.1;
		proxy_set_header Connection ""; # Evita problemas com Upgrade/Connection headers

		# MUITO IMPORTANTE: Desabilitar buffering para uploads S3 grandes
		proxy_request_buffering    off; 
		proxy_buffering            off; # Também recomendado para downloads grandes

	}
}
